name: B_Test_Win 2022

on:
  workflow_dispatch:

jobs:
  deployment:
    runs-on: windows-2022
    timeout-minutes: 800

    env:
      # --- وقت الإغلاق الخاص بك (بالدقائق) ---
      TIME_JOB: "340" 
      # --------------------------------------
      aa2: "XCDOOD"
      aa3: "Zxxz4444"
      LINKS_LIST_URL: "https://tinyurl.com/linksadsadsads2254as"
      KEY_CHOICE: "2"
      PYTHONIOENCODING: "utf-8"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. إعداد النظام والمستخدمين (لن يتوقف الكود إذا فشلت)
      - name: System & RDP Setup
        continue-on-error: true
        shell: pwsh
        run: |
          Write-Host "==== 1. CONFIGURING RDP & USERS ===="
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          $Pass = $env:aa3
          $Secure = ConvertTo-SecureString $Pass -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Secure
          if (-not (Get-LocalUser -Name $env:aa2 -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $env:aa2 -Password $Secure -AccountNeverExpires
              Add-LocalGroupMember Administrators $env:aa2
              Add-LocalGroupMember "Remote Desktop Users" $env:aa2
          }

      # 2. تحميل الحزمة الأساسية (لن يتوقف الكود إذا فشلت كافة الروابط)
      - name: Download & Extract App Bundle
        continue-on-error: true
        shell: pwsh
        run: |
          Write-Host "==== 2. DOWNLOADING APP BUNDLE ===="
          $TempDir = Join-Path $env:TEMP 'AppBundle'
          New-Item -Path $TempDir -ItemType Directory -Force | Out-Null
          $BundleZip = Join-Path $env:TEMP 'app_bundle.zip'
          
          $LinksText = Invoke-RestMethod -Uri $env:LINKS_LIST_URL
          $Urls = $LinksText -split "`r?`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -match "^http" }
          
          $Success = $false
          foreach ($Url in $Urls) {
              try {
                  Write-Host "Trying Bundle Link: $Url"
                  Invoke-WebRequest -Uri $Url -OutFile $BundleZip -UseBasicParsing -ErrorAction Stop -TimeoutSec 180
                  Expand-Archive -Path $BundleZip -DestinationPath $TempDir -Force -ErrorAction Stop
                  $Success = $true; break
              } catch {
                  Write-Host "Link failed/corrupted. Moving to next..."
                  if (Test-Path $BundleZip) { Remove-Item $BundleZip -Force }
              }
          }

      # 3. تثبيت RustDesk (لن يتوقف الكود إذا حدث خطأ في التثبيت)
      - name: RustDesk Configuration
        continue-on-error: true
        shell: python
        run: |
          import subprocess, os, time
          bundle_dir = os.path.join(os.environ['TEMP'], 'AppBundle')
          try:
              rust_installer = next((os.path.join(root, f) for root, _, files in os.walk(bundle_dir) for f in files if "rust" in f.lower() and f.endswith(".exe")), None)
              if rust_installer:
                  subprocess.run([rust_installer, "--silent-install"], check=True)
                  time.sleep(15)
                  rust_exe = r"C:\Program Files\RustDesk\rustdesk.exe"
                  subprocess.run([rust_exe, "--password", os.environ['aa3']], check=True)
                  time.sleep(5)
                  result = subprocess.run([rust_exe, "--get-id"], capture_output=True, text=True, check=True)
                  print(f"\n{'='*30}\nRUSTDESK LOGIN\nID: {result.stdout.strip()}\nPASS: {os.environ['aa3']}\n{'='*30}\n")
          except Exception as e:
              print(f"Error in RustDesk step: {e}")

      # 4. تثبيت Tailscale وإظهار البيانات (لن يتوقف الكود إذا فشلت)
      - name: Tailscale Setup
        continue-on-error: true
        shell: pwsh
        run: |
          $ExtractDir = Join-Path $env:TEMP 'AppBundle'
          $TsInstaller = Get-ChildItem -Path $ExtractDir -Filter "*tailscale*.msi" -Recurse | Select-Object -First 1
          if ($TsInstaller) { Start-Process msiexec.exe -ArgumentList '/i', $TsInstaller.FullName, '/quiet', '/norestart' -Wait }
          
          $KeyFile = Get-ChildItem -Path $ExtractDir -Filter "key$($env:KEY_CHOICE).txt" -Recurse | Select-Object -First 1
          if ($KeyFile) {
              $Encoded = (Get-Content $KeyFile.FullName -Raw).Trim()
              $RealKey = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($Encoded)).Trim()
              $TsExe = Join-Path $env:ProgramFiles 'Tailscale\tailscale.exe'
              Start-Process -FilePath $TsExe -ArgumentList "up --authkey=$RealKey --hostname=RDP-Professional" -Wait
              $ip = & $TsExe ip -4
              Write-Host "`n=============================="
              Write-Host "Tailscale IP: $ip"
              Write-Host "User: runneradmin"
              Write-Host "Password: $($env:aa3)"
              Write-Host "=============================="
          }

      # 5. استخراج الملفات الداخلية (لن يتوقف الكود إذا فشلت الروابط)
      - name: Deploy Important Files to Desktop
        continue-on-error: true
        shell: pwsh
        run: |
          $BundleDir = Join-Path $env:TEMP 'AppBundle'
          $DesktopPath = Join-Path $env:USERPROFILE 'Desktop'
          
          function Download-And-Verify($TxtFile, $DestPath) {
              if (Test-Path $TxtFile) {
                  $Urls = Get-Content $TxtFile | ForEach-Object { $_.Trim() } | Where-Object { $_ -match "^http" }
                  $TempZip = Join-Path $env:TEMP "verify_$(Get-Random).zip"
                  foreach ($Url in $Urls) {
                      try {
                          Write-Host "Testing Link: $Url"
                          Invoke-WebRequest -Uri $Url -OutFile $TempZip -UseBasicParsing -ErrorAction Stop -TimeoutSec 120
                          New-Item -Path $DestPath -ItemType Directory -Force | Out-Null
                          Expand-Archive -Path $TempZip -DestinationPath $DestPath -Force -ErrorAction Stop
                          Remove-Item $TempZip -Force
                          return $true
                      } catch { if (Test-Path $TempZip) { Remove-Item $TempZip -Force } }
                  }
              }
              return $false
          }

          $File1 = Get-ChildItem -Path $BundleDir -Filter "Link ZIP_URL.txt" -Recurse | Select-Object -First 1
          if ($File1) {
              $DesktopExtract = Join-Path $env:TEMP 'DesktopFiles'
              if (Download-And-Verify $File1.FullName $DesktopExtract) {
                  Get-ChildItem -Path $DesktopExtract -Recurse -File | ForEach-Object { Move-Item $_.FullName $DesktopPath -Force -ErrorAction SilentlyContinue }
              }
          }

          $File2 = Get-ChildItem -Path $BundleDir -Filter "*THREE_ZIP_URL*.txt" -Recurse | Select-Object -First 1
          if ($File2) {
              $ThreeDir = Join-Path $env:TEMP 'THREE_EXTRACTED'
              Download-And-Verify $File2.FullName $ThreeDir | Out-Null
          }

      # 6. تثبيت المتصفحات والكيرنل (لن يتوقف الكود إذا لم يجد الملفات)
      - name: Browser & Kernel Setup
        continue-on-error: true
        shell: pwsh
        run: |
          $BundleDir = Join-Path $env:TEMP 'AppBundle'
          $ThreeDir = Join-Path $env:TEMP 'THREE_EXTRACTED'
          
          # NST Browser
          $NstInst = Get-ChildItem -Path $BundleDir -Filter "*nst*.exe" -Recurse | Select-Object -First 1
          if ($NstInst) {
              Start-Process -FilePath $NstInst.FullName -ArgumentList "/VERYSILENT", "/NORESTART", "/S" -Wait
              $NstK = Get-ChildItem -Path $ThreeDir -Filter "nstchrome.zip" -Recurse | Select-Object -First 1
              if ($NstK) {
                  $NstDest = "C:\Users\runneradmin\.nst-agent\download\kernels\nstchrome"
                  New-Item -ItemType Directory -Path $NstDest -Force | Out-Null
                  Expand-Archive -Path $NstK.FullName -DestinationPath $NstDest -Force
              }
          }

          # BitBrowser
          $BitInst = Get-ChildItem -Path $BundleDir -Filter "*BitBrowser*.exe" -Recurse | Select-Object -First 1
          if ($BitInst) {
              Start-Process -FilePath $BitInst.FullName -ArgumentList "/S", "/allusers", "/norestart" -Wait
              $BitK = Get-ChildItem -Path $ThreeDir -Filter "bitchrom.zip" -Recurse | Select-Object -First 1
              if ($BitK) {
                  $BitDest = "C:\Users\runneradmin\AppData\Roaming\BitBrowser\Chrome-bin"
                  New-Item -ItemType Directory -Path $BitDest -Force | Out-Null
                  Expand-Archive -Path $BitK.FullName -DestinationPath $BitDest -Force
              }
          }

      # 7. تثبيت NoMachine (لن يتوقف الكود إذا فشلت)
      - name: Install NoMachine
        continue-on-error: true
        shell: pwsh
        run: |
          $NmInstaller = Get-ChildItem -Path (Join-Path $env:TEMP 'AppBundle') -Filter "*nomachine*.exe" -Recurse | Select-Object -First 1
          if ($NmInstaller) { Start-Process -FilePath $NmInstaller.FullName -ArgumentList "/VERYSILENT", "/NORESTART" -Wait }

      # 8. العداد الذكي وفحص ملف الإيقاف (هذه الخطوة ستحافظ على الجلسة حتى لو فشل كل ما سبق)
      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "==== SETUP COMPLETED. STARTING TIMER ===="
          $KeepAliveMinutes = [int]$env:TIME_JOB
          
          # 1. تشغيل العداد الخاص بك أولاً
          Write-Host "Running custom timer for $KeepAliveMinutes minutes..."
          for ($i = $KeepAliveMinutes; $i -gt 0; $i--) {
              Write-Host "Session alive - $i minutes remaining before file check..."
              Start-Sleep -Seconds 60
          }

          # 2. بعد انتهاء وقتك، نبحث عن الملف لتحديد الأكشن
          $StopFile = "C:\stop11stop.txt"
          if (Test-Path $StopFile) {
              Write-Host "----------------------------------------------"
              Write-Host "File [$StopFile] FOUND."
              Write-Host "Action: Skipping shutdown. Waiting for GitHub forced timeout (360m)."
              Write-Host "----------------------------------------------"
              while($true) { Start-Sleep -Seconds 3600 }
          } else {
              Write-Host "----------------------------------------------"
              Write-Host "File [$StopFile] NOT found."
              Write-Host "Action: Closing script now as per custom timer."
              Write-Host "----------------------------------------------"
          }
